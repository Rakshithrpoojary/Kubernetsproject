pipeline{
    agent any
    tools{
        nodejs 'nodejs'
    }

    environment{
        SCANNER_HOME=tool 'sonar-scanner'
        IMAGE_NAME = "rakshithrpoojary/frontend"
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    stages{
        // stage('Cleaning workspace')
        // {
        //     steps{
        //         cleanWs()
        //     }

        // }
        stage("checkout git repo")
        {
            steps{
                git credentialsId: 'git-cred', url:"https://github.com/Rakshithrpoojary/Kubernetsproject.git"
            }
        }
        stage('Sonarqube analysis')
        {
            steps {
                dir('Application-Code/frontend'){
withSonarQubeEnv('sonar-cred-main')
{
sh''' $SCANNER_HOME/bin/sonar-scanner \
-Dsonar.projectName=todo \
-Dsonar.projectKey=todo'''
}
}
            }
        }

        stage('Quality Check')
        {
            steps{
                script{
                    waitForQualityGate abortPipeline:false,credentialsId:'sonar-cred'
                }
            }
        }
        stage('Trivy filescan')
        {
            steps{
                dir('Application-Code/frontend'){
                    sh 'trivy fs . > trivyfs.txt'
                }
            }
        }
        stage('Build Docker Image')
        {
            steps{
                dir('Application-Code/frontend')
                {
                sh'docker build -t frontend .'
                }
            }
        }
        stage ('Docker push')
        {
            steps{
withDockerRegistry(credentialsId: 'docker-cred', url: 'https://index.docker.io/v1/') {
sh 'docker tag frontend rakshithrpoojary/frontend:${BUILD_NUMBER}'
sh 'docker push rakshithrpoojary/frontend:${BUILD_NUMBER}'
}
            }
        }
        stage('Update Deployment YAML') {
      steps {
        sh """
          sed -i 's|image: .*|image: $IMAGE_NAME:$IMAGE_TAG|g' Kubernetes-Manifests-file/Frontend/deployment.yaml
        """
      }
    }

    stage('Commit & Push to Git') {
      steps {
        withCredentials([gitUsernamePassword(credentialsId: 'git-cred', gitToolName: 'Default')]) {
        sh """
          git config user.name "Rakshith"
          git config user.email "poojaryrakshith986@gmail.com"

          git add Kubernetes-Manifests-file/Frontend/deployment.yaml
          git commit -m "Update frontend image to $IMAGE_TAG"
          git push https://github.com/Rakshithrpoojary/Kubernetsproject.git HEAD:main
        """
      }
      }
    }

    }
}