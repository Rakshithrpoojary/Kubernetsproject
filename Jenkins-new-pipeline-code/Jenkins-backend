pipeline{
    agent any
    tools{
        nodejs 'nodejs'
    }
    environment{
        SCANNER_HOME =tool 'sonar-scanner'
         IMAGE_NAME = "rakshithrpoojary/backend"
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    stages{
        stage("Git checkout")
        {
            steps{
                git credentialsId : 'git-cred', url :"https://github.com/Rakshithrpoojary/Kubernetsproject.git"
            }
        }
        stage("Sonarqube scann")
        {
            steps{
                dir('Application-Code/backend'){

                withSonarQubeEnv('sonar-cred-main'){
                sh''' ${SCANNER_HOME}/bin/sonar-scanner \
                -Dsonar.projectName=todobackend \
                -Dsonar.projectKey=todobackend'''
                }
            }
            }
        }
        stage('Quality Check')
        {
            steps{
script{
    waitForQualityGate abortPipeline:false, credentialsId:'sonar-cred'
}
            }
        }
        stage('Trivy Scann')
        {
            steps{
                dir('Application-Code/backend'){

                sh "trivy fs . > trivyfs.txt"
                }
            }
        }
        stage ("Docker build")
        {
steps{

    dir('Application-Code/backend'){
        sh 'docker build -t backend .'
    }
}
        }
        stage("Docker push")
        {
            steps{
                withDockerRegistry(credentialsId:"docker-cred", url: 'https://index.docker.io/v1/')
                {
sh 'docker tag backend rakshithrpoojary/backend:${BUILD_NUMBER}'
sh 'docker push rakshithrpoojary/backend:${BUILD_NUMBER}'
                }
            }
        }
            stage('Deploy to k8s')
        {
            steps{
                sh """
                kubectl set image deployment/backend \
                backend=$IMAGE_NAME:$IMAGE_TAG \
                -n todo
                """
            }
        }

    }
}
